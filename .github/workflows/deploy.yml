# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v2

#       - name: Check if environment.prod.ts exists
#         run: |
#           if [ ! -f src/environments/environment.prod.ts ]; then
#             echo "Error: environment.prod.ts not found!"
#             exit 1
#           fi

#       - name: Set environment variables for Firebase and Discord
#         run: |
#           echo "firebaseConfig=${{secrets.FIREBASE_DETAILS}}" >> $GITHUB_ENV
#           echo "discordConfig=${{secrets.DISCORD_DETAILS}}" >> $GITHUB_ENV

#       - name: Debug environment variables
#         run: |
#           echo "firebaseConfig"
#           echo "discordConfig"
  
#       - name: Install dependencies
#         run: |
#           npm install -g @angular/cli
#           npm install

#       - name: Build the app
#         run: |
#           echo "Building the app with Firebase and Discord configs"
#           npm run build -- --configuration production


name: Deploy Production

on:
  push:
    branches:
      - main  # Trigger sul branch principale

env:
  FIREBASE_DETAILS: ${{ secrets.FIREBASE_DETAILS }}  # Variabili da GitHub Secrets
  DISCORD_DETAILS: ${{ secrets.DISCORD_DETAILS }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Replace Environment Variables in environment.prod.js
        run: |
          # Sostituisce i placeholder nel file con i valori delle variabili d'ambiente
          ESCAPED_FIREBASE_DETAILS=$(echo "$FIREBASE_DETAILS" | sed -e 's/[\/&]/\\&/g')
          ESCAPED_DISCORD_DETAILS=$(echo "$DISCORD_DETAILS" | sed -e 's/[\/&]/\\&/g')

          sed -i "s#|***FIREBASE_DETAILS***|#$ESCAPED_FIREBASE_DETAILS#g" src/environments/environment.prod.js
          sed -i "s#|***DISCORD_DETAILS***|#$ESCAPED_DISCORD_DETAILS#g" src/environments/environment.prod.js

      - name: Install Dependencies
        run: npm install

      - name: Build Angular for Production
        run: npm run build -- --configuration=production

      - name: Build the app
        run: |
          echo "Building the app with Firebase and Discord configs"
          npm run build -- --configuration production
